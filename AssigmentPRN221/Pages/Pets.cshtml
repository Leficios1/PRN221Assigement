@page
@model AssigmentPRN221.Pages.PetsModel
@{
    <h1>CRUD Pets</h1>
    <div id="petData" style="display: none;">@Model.PetDataJson</div>

    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Pet Name</th>
                <th>Pet Type</th>
                <th>BirthDate</th>
                <th>Pet Gender</th>
                <th>Pet Special Features</th>
                <th>Status</th>
                <th>User Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var pet in Model.Pets)
            {
                <tr>
                    <td>@pet.Id</td>
                    <td>@pet.PetName</td>
                    <td>@pet.PetType</td>
                    <td>@pet.BirthDate.ToString("dd-MM-yyyy")</td>
                    <td>@(pet.PetGender ?? "Unknown")</td>
                    <td>@(pet.PetSecialFeatures ?? "Unknown")</td>
                    <td>@pet.Status</td>
                    <td>@pet.UserName</td>
                    <td>
                        <button class="btn btn-primary" onclick="showUpdatePopup(@pet.Id)">Update</button>
                        <button class="btn btn-danger" onclick="showDeletePopup(@pet.Id)">Delete</button>
                        <button class="btn btn-info" onclick="toggleDetails(@pet.Id)">Details</button>
                    </td>
                </tr>
                <tr id="details-@pet.Id" style="display: none;">
                    <td colspan="9">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Record Id</th>
                                    <th>Vet Id</th>
                                    <th>Date</th>
                                    <th>Diagnosis</th>
                                    <th>Treatment</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in pet.petRecordDTOs)
                                {
                                    <tr>
                                        <td>@record.Id</td>
                                        <td>@record.VetId</td>
                                        <td>@record.Date.ToString("dd-MM-yyyy")</td>
                                        <td>@record.Diagnosis</td>
                                        <td>@record.Treatment</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Update Popup -->
    <div id="updatePopup" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUpdatePopup()">&times;</span>
            <h2>Update Pet</h2>
            <form id="updateForm" method="post">
                <input type="hidden" id="updatePetId" name="Id" />
                <label for="updatePetName">Pet Name:</label>
                <input type="text" id="updatePetName" name="PetName" required />
                <label for="updatePetType">Pet Type:</label>
                <input type="text" id="updatePetType" name="PetType" required />
                <label for="updatePetBirthDate">Birth Date:</label>
                <input type="date" id="updatePetBirthDate" name="BirthDate" required />
                <label for="updatePetGender">Gender:</label>
                <input type="text" id="updatePetGender" name="PetGender" />
                <label for="updatePetSpecialFeatures">Special Features:</label>
                <input type="text" id="updatePetSpecialFeatures" name="PetSpecialFeatures" />
                <label for="updateStatus">Status:</label>
                <input type="number" id="updateStatus" name="Status" required />
                <button type="submit" class="btn btn-primary">Update</button>
            </form>
        </div>
    </div>

    <!-- Delete Popup -->
    <div id="deletePopup" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeletePopup()">&times;</span>
            <h2>Are you sure you want to delete this pet?</h2>
            <form id="deleteForm" method="post">
                <input type="hidden" id="deletePetId" name="Id" />
                <button type="submit" class="btn btn-danger">Delete</button>
                <button type="button" class="btn btn-secondary" onclick="closeDeletePopup()">Cancel</button>
            </form>
        </div>
    </div>
}

@section Scripts {
    <script>
        var petData = JSON.parse(document.getElementById('petData').textContent);

        function showUpdatePopup(id) {
            var selectedPet = petData.find(p => p.Id === id);
            document.getElementById('updatePetId').value = selectedPet.Id;
            document.getElementById('updatePetName').value = selectedPet.PetName;
            document.getElementById('updatePetType').value = selectedPet.PetType;
            document.getElementById('updatePetBirthDate').value = new Date(selectedPet.BirthDate).toISOString().substring(0, 10);
            document.getElementById('updatePetGender').value = selectedPet.PetGender;
            document.getElementById('updatePetSpecialFeatures').value = selectedPet.PetSecialFeatures;
            document.getElementById('updateStatus').value = selectedPet.Status;
            document.getElementById('updatePopup').style.display = 'block';
        }

        function closeUpdatePopup() {
            document.getElementById('updatePopup').style.display = 'none';
        }

        function showDeletePopup(id) {
            document.getElementById('deletePetId').value = id;
            document.getElementById('deletePopup').style.display = 'block';
        }

        function closeDeletePopup() {
            document.getElementById('deletePopup').style.display = 'none';
        }

        function updatePet() {
            var formData = new FormData(document.getElementById('updateForm'));
            fetch('@Url.Page("/Pets", "OnPostUpdateAsync")', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Tải lại trang sau khi cập nhật thành công
                    } else {
                        alert('Failed to update pet.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating pet.');
                });
        }
        function toggleDetails(id) {
            var detailsRow = document.getElementById('details-' + id);
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
            } else {
                detailsRow.style.display = 'none';
            }
        }
    </script>
}
